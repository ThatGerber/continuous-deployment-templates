#cloud-config
write_files:
  - path: /opt/docker/install.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      DOCKER_VERSION=$1
      apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
      mkdir -p /etc/apt/sources.list.d/
      echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" > /etc/apt/sources.list.d/docker.list
      apt-get update
      apt-get install -y docker-engine=$DOCKER_VERSION

  - path: /opt/rancher/rancher.sh
    permissions: "0755"
    content: |
      #!/bin/sh
      set -e
      umask 077

      IMAGE=$1
      if [ "$IMAGE" = "" ]; then
          IMAGE=rancher/server
      fi

      mkdir -p /var/lib/rancher/etc/server
      mkdir -p /var/lib/rancher/etc/ssl
      mkdir -p /var/lib/rancher/bin

      echo Creating /var/lib/rancher/etc/server.conf
      cat > /var/lib/rancher/etc/server.conf << EOF

      export CATTLE_DB_CATTLE_MYSQL_HOST=${rdsUrl}
      export CATTLE_DB_CATTLE_MYSQL_PORT=3306
      export CATTLE_DB_CATTLE_MYSQL_NAME=rancher
      export CATTLE_DB_CATTLE_USERNAME=biroot
      export CATTLE_DB_CATTLE_PASSWORD=${rdsPass}

      EOF

      echo Creating /var/lib/rancher/bin/rancher-start.sh
      cat > /var/lib/rancher/bin/rancher-start.sh << "EOF"
      #!/bin/sh
      set -e

      IMAGE=$1
      if [ "$IMAGE" = "" ]; then
          echo Usage: $0 DOCKER_IMAGE
          exit 1
      fi

      docker rm -fv rancher-server >/dev/null 2>&1 || true
      ID=`docker run --restart=always -d -v /var/run/docker.sock:/var/run/docker.sock --name rancher-server --net host --privileged -v /var/lib/rancher/etc:/var/lib/rancher/etc $IMAGE`

      echo Started container rancher $ID
      echo Run the below to see the logs
      echo
      echo docker logs -f rancher
      EOF

      chmod +x /var/lib/rancher/bin/rancher-start.sh

      echo Running: /var/lib/rancher/bin/rancher-start.sh $IMAGE
      echo To re-run please execute: /var/lib/rancher/bin/rancher-start.sh $IMAGE
      exec /var/lib/rancher/bin/rancher-start.sh $IMAGE

runcmd:
  - [ cloud-init-per, once, ssm, /opt/ssm-install.sh ]
  - [ cloud-init-per, once, docker, /opt/docker/install.sh, 1.11.2-0~trusty ]
  - [ cloud-init-per, once, rancher, /opt/rancher/rancher.sh, "${image}" ]
